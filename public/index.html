<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>AstroEr ‚Äì AI Powered Vedic Astrology | by Vedang Soni</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- SEO -->
<meta name="description" content="AstroEr ‚Äì AI-powered Vedic Astrology insights. Generate your Kundli-based personality report instantly in English or Hindi.">
<meta name="keywords" content="AstroEr, kundli, astrology, vedic, horoscope, AI kundli, birth chart, astro report">

<style>
:root {
  --bg: #020617;
  --fg: #ffffff;
  --glass: rgba(255,255,255,0.08);
  --card: rgba(255,255,255,0.12);
  --border: rgba(255,255,255,0.16);
  --primary: #6366f1;
  --radius: 20px;
}
body.light {
  --bg: #f1f5f9;
  --fg: #111827;
  --glass: rgba(255,255,255,0.7);
  --card: rgba(255,255,255,0.9);
  --border: rgba(0,0,0,0.18);
}
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:"Inter",sans-serif;
}
body {
  background:var(--bg);
  color:var(--fg);
  min-height:100vh;
  padding:20px;
  display:flex;
  justify-content:center;
  overflow-x:hidden;
}

/* INTRO */
#intro-screen {
  position:fixed; 
  inset:0;
  display:flex; 
  justify-content:center; 
  align-items:center;
  background:radial-gradient(circle,#0f172a,#000);
  z-index:9999;
}
.intro-aura{
  position:absolute;
  width:300px;
  height:300px;
  background:radial-gradient(circle,rgba(120,120,255,0.4),transparent 70%);
  filter:blur(60px);
  animation:auraMove 9s infinite ease-in-out;
}
.aura2{
  width:330px;
  height:330px;
  background:radial-gradient(circle,rgba(255,100,180,0.45),transparent 70%);
  animation-duration:11s;
}
@keyframes auraMove {
  0%{transform:translate(-60px,-60px);}
  50%{transform:translate(80px,90px);}
  100%{transform:translate(-60px,-60px);}
}
.intro-center{text-align:center;z-index:10;}
.intro-om{
  font-size:90px;
  font-weight:900;
  color:#fbbf24;
  text-shadow:0 0 32px #fbbf24aa;
  cursor:pointer;
  animation:omPulse 2s infinite ease-in-out;
}
@keyframes omPulse{
  0%{transform:scale(1);}
  50%{transform:scale(1.2);}
  100%{transform:scale(1);}
}
.tap-text{
  margin-top:12px;
  font-size:17px;
  color:#ffffffaa;
  animation:tapBlink 2s infinite;
}
@keyframes tapBlink{
  0%{opacity:.4;}50%{opacity:1;}100%{opacity:.4;}
}
.intro-exit{
  animation:introFade .6s forwards;
}
@keyframes introFade{
  to{opacity:0;visibility:hidden;}
}

/* MAIN WRAPPER */
.app {
  width:100%;
  max-width:1200px;
  background:var(--glass);
  border-radius:var(--radius);
  border:1px solid var(--border);
  backdrop-filter:blur(14px);
  opacity:0;
  transform:translateY(40px);
  transition:.6s;
}
.app.visible{
  opacity:1;
  transform:translateY(0);
}

/* HEADER */
header{
  background:linear-gradient(to right,#fbbf24,#f97316);
  padding:18px 25px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  color:#111827;
}
.brand{
  display:flex;
  gap:12px;
  align-items:center;
}
.brand-icon{
  width:45px;
  height:45px;
  border-radius:50%;
  background:#111827;
  color:#fbbf24;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  font-weight:900;
}
.theme-toggle{
  font-size:27px;
  cursor:pointer;
}

/* LAYOUT */
main{
  display:flex;
  flex-wrap:wrap;
}
.left,.right{
  width:100%;
  padding:24px;
}
@media(min-width:850px){
  .left,.right{width:50%;}
  .left{border-right:1px solid var(--border);}
}

/* FORM */
form{
  display:flex;
  flex-direction:column;
  gap:15px;
}
input,textarea,select{
  padding:12px;
  border-radius:var(--radius);
  border:1px solid var(--border);
  color:var(--fg);
  background:rgba(255,255,255,0.14);
}
select{
  background:#0f172a;
}
body.light select{
  background:white;
  color:#111827;
  border-color:rgba(0,0,0,0.18);
}
input:focus,textarea:focus,select:focus{
  border-color:var(--primary);
  transform:scale(1.02);
}

.btn-primary{
  padding:13px;
  border:none;
  border-radius:999px;
  background:linear-gradient(to right,#fbbf24,#f97316);
  color:#111827;
  font-weight:600;
  cursor:pointer;
}

/* RESULT */
.result-card{
  min-height:260px;
  padding:18px;
  border-radius:var(--radius);
  border:1px solid var(--border);
  background:var(--card);
  white-space:pre-wrap;
  font-size:17px;
  line-height:1.55;
}

/* CITY DROPDOWN */
#city-suggestions{
  position:absolute;
  top:100%;
  left:0;
  right:0;
  background:#0f172a;
  max-height:250px;
  overflow-y:auto;
  border-radius:var(--radius);
  border:1px solid var(--border);
  display:none;
  z-index:999;
  color:#e5e7eb;
}
.city-suggestion-item{
  padding:10px 12px;
  cursor:pointer;
  border-bottom:1px solid rgba(255,255,255,0.12);
}
.city-suggestion-item:hover{
  background:rgba(255,255,255,0.2);
}

/* Light mode city dropdown fix */
body.light #city-suggestions{
  background:#ffffff;
  color:#111827;
  border-color:rgba(0,0,0,0.18);
}
body.light .city-suggestion-item{
  border-bottom:1px solid #e5e7eb;
}
body.light .city-suggestion-item:hover{
  background:#f3f4f6;
}

/* FLOAT BAR */
.floating-bar{
  position:fixed;
  bottom:0;left:0;right:0;
  padding:10px;
  background:var(--glass);
  backdrop-filter:blur(12px);
  border-top:1px solid var(--border);
  display:flex;
  justify-content:space-around;
  z-index:999;
}
.action-btn{
  text-align:center;
  cursor:pointer;
}
.action-btn span{
  font-size:23px;
  display:block;
  margin-bottom:4px;
}

/* FOOTER */
footer{
  text-align:center;
  font-size:12px;
  opacity:.6;
  padding:20px 0 80px;
}

/* LOADER */
.loader{
  width:40px;
  height:40px;
  border-radius:50%;
  border:4px solid rgba(255,255,255,0.2);
  border-top-color:#fbbf24;
  animation:spin .7s linear infinite;
  margin:20px auto;
}
@keyframes spin{
  to{transform:rotate(360deg);}
}
</style>
</head>

<body>

<!-- INTRO -->
<div id="intro-screen">
  <div class="intro-aura"></div>
  <div class="intro-aura aura2"></div>
  <div class="intro-center">
    <div id="enterOm" class="intro-om">‡•ê</div>
    <div class="tap-text">Tap to Enter</div>
  </div>
</div>

<div class="app" id="mainApp">
<header>
  <div class="brand">
    <div class="brand-icon">‡•ê</div>
    <h2>AstroEr</h2>
  </div>
  <div id="themeToggle" class="theme-toggle">üåô</div>
</header>

<main>

<section class="left">
  <h2>Enter Birth Details</h2>

  <form id="astro-form">
    <div>
      <label>Name</label>
      <input id="name" required>
    </div>

    <div>
      <label>Gender</label>
      <select id="gender" required>
        <option value="">Select</option>
        <option>Male</option>
        <option>Female</option>
        <option>Other</option>
      </select>
    </div>

    <div>
      <label>Date of Birth</label>
      <input type="date" id="dob" required>
    </div>

    <div>
      <label>Time of Birth</label>
      <input type="time" id="tob" required>
    </div>

    <div style="position:relative;">
      <label>City</label>
      <input id="city" placeholder="Start typing..." autocomplete="off" required>
      <div id="city-suggestions"></div>
    </div>

    <div>
      <label>State</label>
      <input id="state" required>
    </div>

    <div>
      <label>Country</label>
      <input id="country" value="India" required>
    </div>

    <div>
      <label>Your Concern (Optional)</label>
      <textarea
        id="notes"
        placeholder="Yaha apna concern likhiye. Agar aap astrologer se baat / call karna chahte hain tab hi ye box bhariyega. AI report is concern ko use nahi karti, sirf aapki astrologer se baat ke liye hai."
      ></textarea>
    </div>

    <button class="btn-primary">üîÆ Generate Report</button>
  </form>
</section>

<section class="right">
  <h2>Your Astro Report</h2>

  <div style="margin:10px 0;">
    <select id="report-lang">
      <option value="en">English</option>
      <option value="hi">Hindi</option>
    </select>
  </div>

  <div id="result-card" class="result-card">
    Your report will appear here‚Ä¶
  </div>

  <a id="whatsapp-button" class="btn-primary" target="_blank" style="margin-top:12px;display:inline-block;">
    üí¨ Talk to Astrologer
  </a>
</section>

</main>

<footer>
  AstroEr by Vedang Soni ‚Äî All Rights Reserved.
</footer>
</div>

<!-- FLOAT BAR -->
<div class="floating-bar">
  <div class="action-btn" id="copyReport"><span>üìÑ</span>Copy</div>
  <div class="action-btn" id="shareReport"><span>üì§</span>Share</div>
  <div class="action-btn" id="downloadPDF"><span>üì•</span>PDF</div>
</div>

<!-- jsPDF CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ===== GLOBAL STATE ===== */
let descriptionFull = "";
let descriptionEN = "";
let descriptionHI = "";

/* ===== INTRO SCREEN ===== */
document.getElementById("enterOm").onclick = () => {
  const intro = document.getElementById("intro-screen");
  intro.classList.add("intro-exit");
  setTimeout(() => {
    intro.remove();
    document.getElementById("mainApp").classList.add("visible");
  }, 650);
};

/* ===== THEME ===== */
const themeToggle = document.getElementById("themeToggle");
let theme = localStorage.getItem("theme") || "dark";
applyTheme();
function applyTheme(){
  if(theme === "light"){
    document.body.classList.add("light");
    themeToggle.textContent = "‚òÄÔ∏è";
  } else {
    document.body.classList.remove("light");
    themeToggle.textContent = "üåô";
  }
}
themeToggle.onclick = () => {
  theme = theme === "dark" ? "light" : "dark";
  localStorage.setItem("theme", theme);
  applyTheme();
};

/* ===== CITY SEARCH ===== */
let citiesFlat = [];
(async () => {
  try {
    const res = await fetch("/cities.json");
    const data = await res.json();
    for (const [state, distObj] of Object.entries(data)) {
      for (const [dist, cityObj] of Object.entries(distObj)) {
        for (const city of Object.keys(cityObj)) {
          citiesFlat.push({ city, state });
        }
      }
    }
  } catch (e) {
    console.error("City load error:", e);
  }
})();

function fuzzyMatch(q,t){
  q=q.toLowerCase();t=t.toLowerCase();
  if(t.startsWith(q))return 3;
  if(t.includes(q))return 2;
  if(q.split("").every(c=>t.includes(c)))return 1;
  return 0;
}
const cityInput=document.getElementById("city");
const stateInput=document.getElementById("state");
const citySug=document.getElementById("city-suggestions");

cityInput.addEventListener("input",()=>{
  const q=cityInput.value.trim();
  if(q.length<2||!citiesFlat.length){
    citySug.style.display="none";
    return;
  }
  const results=citiesFlat
    .map(c=>({...c,score:fuzzyMatch(q,c.city)}))
    .filter(c=>c.score>0)
    .sort((a,b)=>b.score-a.score)
    .slice(0,25);
  citySug.innerHTML="";
  if(!results.length){
    citySug.style.display="none";
    return;
  }
  results.forEach(c=>{
    const div=document.createElement("div");
    div.className="city-suggestion-item";
    div.textContent=`${c.city}, ${c.state}`;
    div.onclick=()=>{
      cityInput.value=c.city;
      stateInput.value=c.state;
      citySug.style.display="none";
    };
    citySug.appendChild(div);
  });
  citySug.style.display="block";
});
document.addEventListener("mousedown",e=>{
  if(!citySug.contains(e.target)&&e.target!==cityInput){
    citySug.style.display="none";
  }
});

/* ===== ASTRO HELPERS ===== */
function getZodiac(m,d){
  if((m===2&&d>=21)||(m===3&&d<=19))return"Aries";
  if((m===3&&d>=20)||(m===4&&d<=20))return"Taurus";
  if((m===4&&d>=21)||(m===5&&d<=20))return"Gemini";
  if((m===5&&d>=21)||(m===6&&d<=22))return"Cancer";
  if((m===6&&d>=23)||(m===7&&d<=22))return"Leo";
  if((m===7&&d>=23)||(m===8&&d<=22))return"Virgo";
  if((m===8&&d>=23)||(m===9&&d<=22))return"Libra";
  if((m===9&&d>=23)||(m===10&&d<=21))return"Scorpio";
  if((m===10&&d>=22)||(m===11&&d<=21))return"Sagittarius";
  if((m===11&&d>=22)||(m===0&&d<=19))return"Capricorn";
  if((m===0&&d>=20)||(m===1&&d<=18))return"Aquarius";
  return"Pisces";
}
function getLifePath(date){
  let num=[...(date.getFullYear()+""+(date.getMonth()+1)+date.getDate())]
    .reduce((a,b)=>a+ +b,0);
  while(num>9){
    num=[...(""+num)].reduce((x,y)=>x+ +y,0);
  }
  return num;
}
function cleanText(txt){
  return txt.replace(/\*/g,"").replace(/_/g,"").trim();
}
function splitDescription(text){
  const enTag="[ENGLISH]";
  const hiTag="[HINDI]";
  const enIndex=text.indexOf(enTag);
  const hiIndex=text.indexOf(hiTag);
  if(enIndex===-1||hiIndex===-1){
    return{en:text.trim(),hi:""};
  }
  return{
    en:text.slice(enIndex+enTag.length,hiIndex).trim(),
    hi:text.slice(hiIndex+hiTag.length).trim()
  };
}

/* ===== FORM SUBMIT ===== */
document.getElementById("astro-form").onsubmit=async(e)=>{
  e.preventDefault();
  const resultCard=document.getElementById("result-card");
  resultCard.innerHTML=`<div class="loader"></div>`;

  const name=document.getElementById("name").value;
  const gender=document.getElementById("gender").value;
  const dob=document.getElementById("dob").value;
  const tob=document.getElementById("tob").value;
  const city=cityInput.value;
  const state=stateInput.value;
  const country=document.getElementById("country").value;
  const notes=document.getElementById("notes").value;

  const d=new Date(dob);
  const zodiac=getZodiac(d.getMonth(),d.getDate());
  const lifePath=getLifePath(d);

  const payload={name,gender,dob,tob,city,state,country,notes,zodiac,lifePath};

  const res=await fetch("/api/astro",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });

  const data=await res.json();
  const text=cleanText(data.description||"");
  descriptionFull=text;

  const parts=splitDescription(text);
  descriptionEN=cleanText(parts.en);
  descriptionHI=cleanText(parts.hi);

  document.getElementById("report-lang").value="en";
  resultCard.textContent=descriptionEN||descriptionFull;

  // ‚úÖ WhatsApp ONLY gets details + concern (no AI description)
  const whatsappText =
    `Name: ${name}\n` +
    `Gender: ${gender}\n` +
    `DOB: ${dob}\n` +
    `Time: ${tob}\n` +
    `Place: ${city}, ${state}, ${country}\n` +
    `Concern: ${notes || "Not specified"}`;

  document.getElementById("whatsapp-button").href =
    "https://wa.me/917974517991?text=" + encodeURIComponent(whatsappText);
};

/* ===== LANGUAGE SWITCH ===== */
document.getElementById("report-lang").onchange=()=>{
  const lang=document.getElementById("report-lang").value;
  const resultCard=document.getElementById("result-card");
  if(lang==="en"){
    resultCard.textContent=descriptionEN||descriptionFull;
  }else{
    resultCard.textContent=descriptionHI||descriptionFull;
  }
};

/* ===== COPY (optimized: sirf selected language) ===== */
document.getElementById("copyReport").onclick=()=>{
  const lang=document.getElementById("report-lang").value;
  const text=lang==="en"
    ? (descriptionEN||descriptionFull)
    : (descriptionHI||descriptionFull);
  if(!text){
    alert("Generate report first.");
    return;
  }
  navigator.clipboard.writeText(text);
  alert("Copied!");
};

/* ===== SHARE (optimized: sirf selected language) ===== */
document.getElementById("shareReport").onclick=()=>{
  const lang=document.getElementById("report-lang").value;
  const text=lang==="en"
    ? (descriptionEN||descriptionFull)
    : (descriptionHI||descriptionFull);
  if(!text){
    alert("Generate report first.");
    return;
  }

  if(navigator.share){
    navigator.share({title:"AstroEr Astro Report",text});
  }else{
    navigator.clipboard.writeText(text);
    alert("Copied!");
  }
};

/* ===== PREMIUM PDF v2 (English = jsPDF, Hindi = system PDF with headings) ===== */
document.getElementById("downloadPDF").onclick = async () => {
  const lang = document.getElementById("report-lang").value;
  const textEn = descriptionEN || descriptionFull;
  const textHi = descriptionHI || descriptionFull;

  if (!textEn && !textHi) {
    alert("Generate report first.");
    return;
  }

  /* ---------- HINDI PDF: use browser print (best for Unicode) ---------- */
  if (lang === "hi") {
    const w = window.open("", "_blank");
    const safeHi = (textHi || "").replace(/</g, "&lt;");

    const html = `
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>AstroEr Hindi Report</title>
<style>
  body {
    font-family: "Noto Sans Devanagari", "Mangal", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    margin: 40px;
    line-height: 1.6;
    color: #111827;
  }
  .header {
    text-align: center;
    margin-bottom: 24px;
  }
  .header-title {
    font-size: 22px;
    font-weight: 700;
  }
  .header-sub {
    font-size: 13px;
    color: #4b5563;
  }
  .divider {
    margin: 16px 0 24px;
    height: 2px;
    background: linear-gradient(to right, #fbbf24, #f97316);
  }
  .section-title {
    font-size: 15px;
    font-weight: 600;
    margin-top: 10px;
    margin-bottom: 6px;
    color: #374151;
  }
  .footer {
    margin-top: 32px;
    font-size: 11px;
    color: #6b7280;
    border-top: 1px solid #e5e7eb;
    padding-top: 8px;
    text-align: right;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-family: inherit;
    font-size: 14px;
  }
</style>
</head>
<body>
  <div class="header">
    <div class="header-title">AstroEr ‚Äì Hindi Astro Report</div>
    <div class="header-sub">AI se taiyaar ki gayi vyaktigat jyotishiya samajh (Hindi)</div>
  </div>
  <div class="divider"></div>

  <div class="section-title">‚Ä¢ ‡§∏‡•ç‡§µ‡§≠‡§æ‡§µ, ‡§∏‡•ã‡§ö ‡§î‡§∞ ‡§≠‡§æ‡§µ‡§®‡§æ‡§è‡§Å</div>
  <div class="section-title">‚Ä¢ ‡§ï‡§∞‡§ø‡§Ø‡§∞ ‡§î‡§∞ ‡§∂‡§ø‡§ï‡•ç‡§∑‡§æ ‡§ï‡•Ä ‡§¶‡§ø‡§∂‡§æ</div>
  <div class="section-title">‚Ä¢ ‡§ß‡§®, ‡§∏‡•ç‡§•‡§ø‡§∞‡§§‡§æ ‡§î‡§∞ ‡§ú‡§ø‡§Æ‡•ç‡§Æ‡•á‡§¶‡§æ‡§∞‡•Ä</div>
  <div class="section-title">‚Ä¢ ‡§∞‡§ø‡§∂‡•ç‡§§‡•á, ‡§™‡§∞‡§ø‡§µ‡§æ‡§∞ ‡§î‡§∞ ‡§≠‡§æ‡§µ‡§®‡§æ‡§§‡•ç‡§Æ‡§ï ‡§ú‡•Å‡§°‡§º‡§æ‡§µ</div>
  <div class="section-title">‚Ä¢ ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§∏‡•á ‡§ú‡•Å‡§°‡§º‡•Ä ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§™‡•ç‡§∞‡§µ‡•É‡§§‡•ç‡§§‡§ø‡§Ø‡§æ‡§Å</div>
  <div class="section-title">‚Ä¢ ‡§∏‡§Ç‡§§‡•Å‡§≤‡§® ‡§î‡§∞ ‡§ó‡•ç‡§∞‡•ã‡§• ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡•Å‡§ù‡§æ‡§µ</div>

  <pre>${safeHi}</pre>

  <div class="footer">
    AstroEr by Vedang Soni ‚Äî All Rights Reserved.
  </div>
</body>
</html>`;

    w.document.open();
    w.document.write(html);
    w.document.close();
    w.focus();
    w.print();   // user "Save as PDF" choose karega
    return;
  }

  /* ---------- ENGLISH PDF: fancy jsPDF gold design ---------- */
  const text = textEn;
  let jsPDFConstructor = null;
  if (window.jspdf && window.jspdf.jsPDF) jsPDFConstructor = window.jspdf.jsPDF;
  else if (window.jsPDF) jsPDFConstructor = window.jsPDF;
  if (!jsPDFConstructor) {
    alert("PDF library not loaded.");
    return;
  }

  const doc = new jsPDFConstructor({unit:"pt",format:"a4"});
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();

  /* GOLD HEADER */
  doc.setFillColor(251,191,36); // #fbbf24
  doc.rect(0,0,pageWidth,90,"F");

  /* LOGO */
  try{
    const logoBase64=await getBase64Image("/logo.png");
    doc.addImage(logoBase64,"PNG",40,20,60,60);
  }catch(e){
    console.warn("Logo load failed:",e);
  }

  /* TITLE */
  doc.setFont("Helvetica","bold");
  doc.setTextColor(17,24,39); // almost black
  doc.setFontSize(24);
  doc.text("ASTROER ASTROLOGY REPORT",120,45);
  doc.setFont("Helvetica","normal");
  doc.setFontSize(11);
  doc.text("AI-powered Vedic Astrology Insights",120,65);

  /* GOLD DIVIDER */
  doc.setDrawColor(251,191,36);
  doc.setLineWidth(1.2);
  doc.line(40,90,pageWidth-40,90);

  /* OM WATERMARK (FAINT) */
  doc.saveGraphicsState && doc.saveGraphicsState();
  if(doc.setGState){
    const gState=doc.GState({opacity:0.06});
    doc.setGState(gState);
  }
  doc.setFontSize(160);
  doc.setTextColor(209,213,219);
  doc.text("‡•ê",pageWidth/2-40,pageHeight/2+40,{angle:45});
  doc.setTextColor(0,0,0);
  doc.setFontSize(12);
  doc.restoreGraphicsState && doc.restoreGraphicsState();

  /* WHITE CARD BACKGROUND FOR CONTENT */
  const cardTop=120;
  doc.setFillColor(255,255,255);
  doc.roundedRect(30,cardTop,pageWidth-60,pageHeight-cardTop-80,16,16,"F");

  /* CONTENT TEXT */
  const marginX=50;
  let y=cardTop+35;
  const maxWidth=pageWidth-marginX*2;
  const lineHeight=16;
  doc.setFont("Times","normal");
  doc.setFontSize(12);
  doc.setTextColor(17,24,39);

  const lines=doc.splitTextToSize(text,maxWidth);

  lines.forEach(line=>{
    if(y>pageHeight-80){
      doc.addPage();

      /* WATERMARK AGAIN */
      doc.saveGraphicsState && doc.saveGraphicsState();
      if(doc.setGState){
        const gState=doc.GState({opacity:0.06});
        doc.setGState(gState);
      }
      doc.setFontSize(160);
      doc.setTextColor(209,213,219);
      doc.text("‡•ê",pageWidth/2-40,pageHeight/2+40,{angle:45});
      doc.setTextColor(17,24,39);
      doc.restoreGraphicsState && doc.restoreGraphicsState();

      /* CARD BACKGROUND NEW PAGE */
      doc.setFillColor(255,255,255);
      doc.roundedRect(30,40,pageWidth-60,pageHeight-80,16,16,"F");

      y=40+30;
    }
    doc.text(line,marginX,y);
    y+=lineHeight;
  });

  /* FOOTER */
  doc.setFont("Helvetica","italic");
  doc.setFontSize(10);
  doc.setTextColor(107,114,128);
  const footerText="AstroEr by Vedang Soni ‚Äî All Rights Reserved.";
  doc.text(footerText,40,pageHeight-30);

  /* PAGE NUMBER */
  const pageCount=doc.internal.getNumberOfPages();
  for(let i=1;i<=pageCount;i++){
    doc.setPage(i);
    doc.setFontSize(9);
    doc.setTextColor(148,163,184);
    const label=`Page ${i} of ${pageCount}`;
    doc.text(label,pageWidth-40-doc.getTextWidth(label),pageHeight-30);
  }

  doc.save(`astroer_report_${lang}.pdf`);
};

/* HELPER: IMAGE -> BASE64 */
function getBase64Image(url){
  return new Promise((resolve,reject)=>{
    const img=new Image();
    img.crossOrigin="Anonymous";
    img.onload=function(){
      const canvas=document.createElement("canvas");
      canvas.width=this.width;
      canvas.height=this.height;
      const ctx=canvas.getContext("2d");
      ctx.drawImage(this,0,0);
      resolve(canvas.toDataURL("image/png"));
    };
    img.onerror=reject;
    img.src=url;
  });
}
</script>
</body>
</html>
