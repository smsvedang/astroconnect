<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AstroConnect</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* ------------------ BASE STYLES ------------------ */
:root {
  --bg: #020617;
  --fg: #ffffff;
  --card: rgba(30,41,59,0.7);
  --border: rgba(148,163,184,0.3);
  --primary: #6366f1;
  --grad1: #4f46e5;
  --grad2: #ec4899;
}

.light {
  --bg: #f1f5f9;
  --fg: #0f172a;
  --card: #ffffff;
  --border: #cbd5e1;
  --primary: #4f46e5;
  --grad1: #6366f1;
  --grad2: #ec4899;
}

* { margin:0; padding:0; box-sizing:border-box; font-family:system-ui,sans-serif; }

body {
  background: var(--bg);
  color: var(--fg);
  padding: 18px;
  min-height: 100vh;
  display:flex;
  justify-content:center;
}

.app {
  width:100%; max-width:1200px;
  background: var(--card);
  border-radius:20px;
  border:1px solid var(--border);
  overflow:hidden;
  box-shadow:0 25px 45px rgba(0,0,0,0.35);
}

/* ------------------ HEADER ------------------ */
header {
  background: linear-gradient(to right, var(--grad1), var(--grad2));
  padding:15px 22px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.brand {
  display:flex; gap:12px; align-items:center;
}
.brand-icon {
  width:42px; height:42px; border-radius:50%;
  background:#fbbf24; color:#000; display:flex;
  align-items:center; justify-content:center;
  font-weight:900; font-size:22px;
}

.theme-toggle {
  cursor:pointer;
  font-size:24px;
}

/* ------------------ PANELS ------------------ */
main { display:flex; flex-wrap:wrap; }
.left, .right { width:100%; padding:22px; }
@media(min-width:850px){
  .left, .right { width:50%; }
  .left { border-right:1px solid var(--border); }
}

/* ------------------ FORM ------------------ */
form { display:flex; flex-direction:column; gap:14px; }

input, textarea, select {
  padding:10px 12px; border-radius:8px;
  border:1px solid var(--border); background:var(--bg);
  color:var(--fg); outline:none;
}
input:focus, textarea:focus, select:focus {
  border-color: var(--primary);
}

.btn-primary {
  background:linear-gradient(to right, var(--grad1), var(--grad2));
  color:#fff; border:none; padding:12px;
  border-radius:999px; font-weight:600;
  cursor:pointer; margin-top:8px;
}

/* ------------------ RESULT ------------------ */
.result-card {
  min-height:260px; background:var(--card);
  border-radius:14px; border:1px solid var(--border);
  padding:15px; white-space:pre-wrap;
}

.loader {
  width:40px; height:40px;
  border:4px solid #ffffff33;
  border-top-color: var(--primary);
  border-radius:50%;
  animation: spin 0.8s linear infinite;
  margin:20px auto;
}
@keyframes spin { to { transform:rotate(360deg);} }

/* ------------------ CITY DROPDOWN ------------------ */
.city-field { position:relative; }
#city-suggestions {
  position:absolute; top:100%; left:0; right:0;
  background:var(--bg); border:1px solid var(--border);
  max-height:240px; overflow-y:auto;
  border-radius:10px; display:none; z-index:50;
}
.city-suggestion-item {
  padding:10px; border-bottom:1px solid var(--border);
  cursor:pointer;
}
.city-suggestion-item:hover {
  background:rgba(99,102,241,0.25);
}

/* ------------------ FLOATING BOTTOM BAR ------------------ */
.floating-bar {
  position:fixed; bottom:0; left:0; right:0;
  background:var(--card);
  border-top:1px solid var(--border);
  padding:10px;
  display:flex; justify-content:space-around;
  z-index:100;
}
.action-btn {
  display:flex; flex-direction:column;
  align-items:center;
  color: var(--fg);
  text-decoration:none;
  font-size:12px;
}
.action-btn span {
  font-size:22px; margin-bottom:4px;
}

/* HIDE ON DESKTOP */
@media(min-width:900px){
  .floating-bar { position:sticky; bottom:auto; top:0; }
}

</style>
</head>

<body>
<div class="app">

<header>
  <div class="brand">
    <div class="brand-icon">‡•ê</div>
    <div><h2>AstroConnect</h2></div>
  </div>

  <div id="themeToggle" class="theme-toggle">üåô</div>
</header>

<main>

<!-- LEFT PANEL --------------------------------------------------- -->
<section class="left">
  <h2>Enter Your Birth Details</h2>

  <form id="astro-form">

    <div>
      <label>Full Name</label>
      <input id="name" required>
    </div>

    <div>
      <label>Gender</label>
      <select id="gender" required>
        <option value="">Select</option>
        <option>Male</option><option>Female</option><option>Other</option>
      </select>
    </div>

    <div>
      <label>Date of Birth</label>
      <input type="date" id="dob" required>
    </div>

    <div>
      <label>Time of Birth</label>
      <input type="time" id="tob" required>
    </div>

    <div class="city-field">
      <label>City</label>
      <input id="city" autocomplete="off" required>
      <div id="city-suggestions"></div>
    </div>

    <div>
      <label>State</label>
      <input id="state" required>
    </div>

    <div>
      <label>Country</label>
      <input id="country" value="India" required>
    </div>

    <div>
      <label>Specific Concern (optional)</label>
      <textarea id="notes" rows="2"></textarea>
    </div>

    <button class="btn-primary">Generate Report</button>
  </form>
</section>

<!-- RIGHT PANEL --------------------------------------------------- -->
<section class="right">
  <h2>Your Astro Report</h2>

  <select id="report-lang">
    <option value="both">English + Hindi</option>
    <option value="en">English</option>
    <option value="hi">Hindi</option>
  </select>

  <div id="result-card" class="result-card">
    <p style="opacity:.6;">Your report will appear here.</p>
  </div>

  <a id="whatsapp-button" class="btn-primary" target="_blank" style="display:inline-block;margin-top:10px;">
    Chat with Astrologer
  </a>
</section>

</main>
</div>


<!-- FLOATING BOTTOM BAR ------------------------------------------ -->
<div class="floating-bar">
  <a class="action-btn" id="copyReport">
    <span>üìÑ</span> Copy
  </a>
  <a class="action-btn" id="shareReport">
    <span>üì§</span> Share
  </a>
  <a class="action-btn" id="downloadPDF">
    <span>üì•</span> PDF
  </a>
</div>



<!-- ======================= FULL SCRIPT ========================== -->
<script>
/* ========= THEME TOGGLE ========= */
const themeToggle = document.getElementById("themeToggle");
let theme = localStorage.getItem("theme") || "dark";
applyTheme();

function applyTheme() {
  if (theme === "light") {
    document.body.classList.add("light");
    themeToggle.textContent = "‚òÄÔ∏è";
  } else {
    document.body.classList.remove("light");
    themeToggle.textContent = "üåô";
  }
}

themeToggle.onclick = () => {
  theme = theme === "dark" ? "light" : "dark";
  localStorage.setItem("theme", theme);
  applyTheme();
};


/* ========= CITY DATA LOAD ========= */
let citiesFlat = [];
(async () => {
  const res = await fetch("/cities.json");
  const json = await res.json();
  for (const [state, districts] of Object.entries(json)) {
    for (const [district, places] of Object.entries(districts)) {
      for (const city of Object.keys(places)) {
        citiesFlat.push({city, state, district, country:"India"});
      }
    }
  }
})();

/* ========= FUZZY SEARCH ========= */
function fuzzyMatch(q, text) {
  q=q.toLowerCase();
  text=text.toLowerCase();
  if (text.startsWith(q)) return 3;
  if (text.includes(q)) return 2;
  if (q.split("").every(ch=>text.includes(ch))) return 1;
  return 0;
}

const cityInput = document.getElementById("city");
const citySuggestionsEl = document.getElementById("city-suggestions");
const stateInput=document.getElementById("state");
const countryInput=document.getElementById("country");

cityInput.addEventListener("input", () => {
  const q = cityInput.value.trim();
  if (q.length < 2) return citySuggestionsEl.style.display = "none";

  const matches = citiesFlat
    .map(c=>({...c,score:fuzzyMatch(q,c.city)}))
    .filter(c=>c.score>0)
    .sort((a,b)=>b.score-a.score)
    .slice(0,20);

  citySuggestionsEl.innerHTML="";
  if (!matches.length) return citySuggestionsEl.style.display="none";

  matches.forEach(c => {
    const item=document.createElement("div");
    item.className="city-suggestion-item";
    item.innerHTML=`<strong>${c.city}</strong><small>${c.state}</small>`;
    item.addEventListener("mousedown", e=>{
      e.preventDefault();
      cityInput.value=c.city;
      stateInput.value=c.state;
      countryInput.value="India";
      citySuggestionsEl.style.display="none";
    });
    citySuggestionsEl.appendChild(item);
  });

  citySuggestionsEl.style.display="block";
});


/* ========= ZODIAC & LIFE PATH ========= */
function getZodiacSign(month, day) {
  if((month===2&&day>=21)||(month===3&&day<=19))return"Aries";
  if((month===3&&day>=20)||(month===4&&day<=20))return"Taurus";
  if((month===4&&day>=21)||(month===5&&day<=20))return"Gemini";
  if((month===5&&day>=21)||(month===6&&day<=22))return"Cancer";
  if((month===6&&day>=23)||(month===7&&day<=22))return"Leo";
  if((month===7&&day>=23)||(month===8&&day<=22))return"Virgo";
  if((month===8&&day>=23)||(month===9&&day<=22))return"Libra";
  if((month===9&&day>=23)||(month===10&&day<=21))return"Scorpio";
  if((month===10&&day>=22)||(month===11&&day<=21))return"Sagittarius";
  if((month===11&&day>=22)||(month===0&&day<=19))return"Capricorn";
  if((month===0&&day>=20)||(month===1&&day<=18))return"Aquarius";
  return"Pisces";
}

function getLifePathNumber(date){
  let sum=[...(date.getFullYear()+""+(date.getMonth()+1)+date.getDate())]
    .reduce((a,b)=>a+ +b,0);
  while(sum>9)sum=[...(""+sum)].reduce((x,y)=>x+ +y,0);
  return sum;
}


/* ========= REPORT GENERATION ========= */
let descriptionFull="", descriptionEN="", descriptionHI="";

function splitDescription(text){
  const en=text.indexOf("[ENGLISH]");
  const hi=text.indexOf("[‡§π‡§ø‡§®‡•ç‡§¶‡•Ä]");
  if(hi===-1)return{en:text,hi:""};
  return {
    en: text.slice(en+9,hi).trim(),
    hi: text.slice(hi+7).trim()
  };
}

const resultCard=document.getElementById("result-card");
document.getElementById("astro-form").addEventListener("submit", async e=>{
  e.preventDefault();

  resultCard.innerHTML = `<div class="loader"></div><p style="text-align:center;">Generating report‚Ä¶</p>`;

  const name=document.getElementById("name").value;
  const gender=document.getElementById("gender").value;
  const dob=document.getElementById("dob").value;
  const tob=document.getElementById("tob").value;
  const notes=document.getElementById("notes").value;
  const city=cityInput.value;
  const state=stateInput.value;
  const country=countryInput.value;

  const date=new Date(dob);
  const zodiac=getZodiacSign(date.getMonth(),date.getDate());
  const lifePath=getLifePathNumber(date);

  const payload={name,gender,dob,tob,city,state,country,notes,zodiac,lifePath};

  const res=await fetch("/api/astro",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });

  const data=await res.json();
  const text=data.description;

  descriptionFull=text;
  const parts=splitDescription(text);
  descriptionEN=parts.en;
  descriptionHI=parts.hi;

  resultCard.textContent=text;

  const waMsg=`Namaste, here is my astro info:

Name: ${name}
DOB: ${dob}
TOB: ${tob}
Place: ${city}, ${state}, ${country}

Concern: ${notes}

Please guide me.`;

  document.getElementById("whatsapp-button")
    .href="https://wa.me/917974517991?text="+encodeURIComponent(waMsg);
});


/* ========= LANGUAGE SWITCH ========= */
document.getElementById("report-lang").onchange = () => {
  const lang = reportLangSelect.value;
  if(lang==="both") resultCard.textContent=descriptionFull;
  if(lang==="en") resultCard.textContent=descriptionEN || descriptionFull;
  if(lang==="hi") resultCard.textContent=descriptionHI || descriptionFull;
};


/* ========= COPY REPORT ========= */
document.getElementById("copyReport").onclick = () => {
  navigator.clipboard.writeText(descriptionFull);
  alert("Copied to clipboard!");
};

/* ========= SHARE REPORT ========= */
document.getElementById("shareReport").onclick = async () => {
  if (navigator.share) {
    navigator.share({
      title:"My Astro Report",
      text:descriptionFull
    });
  } else {
    navigator.clipboard.writeText(descriptionFull);
    alert("Sharing not supported. Report copied!");
  }
};

/* ========= PDF DOWNLOAD ========= */
document.getElementById("downloadPDF").onclick = () => {
  const w=window.open("", "_blank");
  w.document.write(`
    <html><head><title>Astro Report</title></head>
    <body>
      <pre>${descriptionFull.replace(/</g,"&lt;")}</pre>
    </body></html>
  `);
  w.print();
};

</script>
</body>
</html>
